import Product from "./product.js";
import Validate from "./validata.js"

const classvalidate = new Validate();


const getlistproduct = () => {
    const promise = axios({
        url: "https://68f5f9ef6b852b1d6f15ab33.mockapi.io/product",
        method: 'GET',
    })

    promise
        .then((result) => {
            // console.log(result.data)
            renderproduct(result.data)
            search(result.data)
            document.getElementById("sortSelect").addEventListener("change", () => {
                sortSelect(result.data);
            });
        })
        .catch(() => {
            console.log()

        })
}
getlistproduct()


const validation = (name, price, img, screen, backCamera, frontCamera, desc, type) => {
    let isvalid = true;

    //T√™n s·∫£n ph·∫©m: kh√¥ng ƒë·ªÉ tr·ªëng.
    isvalid &= classvalidate.khongtrong(name, "tbname", "(*) Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m") &&
        classvalidate.checkLength(name, "tbname", "(*) T√™n s·∫£n ph·∫©m t·ªëi ƒëa 20 k√Ω t·ª±", 0, 20)

    isvalid &= classvalidate.khongtrong(price, "tbprice", "(*) Vui l√≤ng nh·∫≠p gi√° s·∫£n ph·∫©m") &&
        classvalidate.checknumber(price, "tbprice", "(*) Vui l√≤ng nh·∫≠p s·ªë") &&
        classvalidate.checksoduong(price, "tbprice", "(*) Vui l√≤ng nh·∫≠p s·ªë > 0")

    isvalid &= classvalidate.khongtrong(img, "tbimg", "(*) Vui l√≤ng nh·∫≠p h√¨nh ·∫£nh")

    isvalid &= classvalidate.khongtrong(screen, "tbscreen", "(*) Vui l√≤ng nh·∫≠p m√†n h√¨nh") &&
        classvalidate.checkLength(screen, "tbscreen", "(*) M√†n h√¨nh t·ªëi ƒëa 15 k√Ω t·ª±", 0, 15)

    isvalid &= classvalidate.khongtrong(backCamera, "tbbackCamera", "(*) Vui l√≤ng nh·∫≠p camera sau") &&
        classvalidate.checkLength(backCamera, "tbbackCamera", "(*) Camera sau t·ªëi ƒëa 15 k√Ω t·ª±", 0, 15)

    isvalid &= classvalidate.khongtrong(frontCamera, "tbfrontCamera", "(*) Vui l√≤ng nh·∫≠p camera tr∆∞·ªõc") &&
        classvalidate.checkLength(frontCamera, "tbfrontCamera", "(*) Camera tr∆∞·ªõc t·ªëi ƒëa 15 k√Ω t·ª±", 0, 15)

    isvalid &= classvalidate.khongtrong(desc, "tbdesc", "(*) Vui l√≤ng nh·∫≠p m√¥ t·∫£") &&
        classvalidate.checkLength(desc, "tbdesc", "(*) M√¥ t·∫£ sp t·ªëi ƒëa 50 k√Ω t·ª±", 0, 50)

    isvalid &= classvalidate.checkOption(type, "tbtype", "(*) Vui l√≤ng nh·∫≠p lo·∫°i")


    return isvalid
}





const getproductid = (id) => {
    const promise = axios({
        url: `https://68f5f9ef6b852b1d6f15ab33.mockapi.io/product/${id}`,
        method: 'GET',
    })

    promise
        .then((result) => {
            const product = result.data
            document.getElementById("name").value = product.name
            document.getElementById("price").value = product.price
            document.getElementById("category").value = product.type
            document.getElementById("img").value = product.img
            document.getElementById("screen").value = product.screen
            document.getElementById("backCamera").value = product.backCamera
            document.getElementById("frontCamera").value = product.frontCamera
            document.getElementById("desc").value = product.desc
        })
        .catch((error) => {
            console.log(error)
        })
}

const updateproductid = (product) => {
    const promise = axios({
        url: `https://68f5f9ef6b852b1d6f15ab33.mockapi.io/product/${product.id}`,
        method: 'PUT',
        data: product,
    })

    promise
        .then((result) => {
            console.log(result)
            getlistproduct()

        })
        .catch((error) => {
            console.log(error)
        })
}





const renderproduct = (data) => {
    let product = "";

    for (let i = 0; i < data.length; i++) {
        const element = data[i];

        product += `

            <tr>
                <td>${i + 1}</td>
                <td>
                  <img src=${element.img} alt=${element.name}>
                </td>
                <td>${element.name}</td>
                <td>${Number(element.price).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' })}</td>
                <td>${element.screen}</td>
                <td>${element.backCamera}</td>
                <td>${element.frontCamera}</td>
                <td>${element.desc}</td>
                <td>${element.type}</td>
                <td class="actions">
                  <button class="btn-edit" data-modal-target="crud-modal" data-modal-toggle="crud-modal" onclick="dandleeditProduct(${element.id})">
                    <i class="fa-solid fa-pencil"></i>
                  </button>
                  <button class="btn-delete" onclick="dandledeletetProduct(${element.id})">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
            </tr>
            `

    }
    document.getElementById("product-list").innerHTML = product

    //gi√∫p Flowbite nh·∫≠n di·ªán c√°c n√∫t m·ªõi render
    initFlowbite();

    //fix l·ªói
    // ü©µ T·ª± ƒë·ªông lo·∫°i b·ªè focus khi modal b·ªã ·∫©n ƒë·ªÉ tr√°nh c·∫£nh b√°o "locked aria-hidden..."
    const observer = new MutationObserver(() => {
        const active = document.activeElement;
        if (active && active.closest("[aria-hidden='true']")) {
            active.blur(); // b·ªè focus kh·ªèi ph·∫ßn t·ª≠ b·ªã ·∫©n
        }
    });

    // Theo d√µi to√†n b·ªô body ƒë·ªÉ ph√°t hi·ªán khi aria-hidden thay ƒë·ªïi (khi modal ƒë√≥ng)
    observer.observe(document.body, { attributes: true, subtree: true });

}


//l·∫•y d·ªØ li·ªáu ra khi nh·∫•n n√∫t c·∫≠p nh·∫≠t
const dandleeditProduct = (id) => {
    // console.log(id)
    document.getElementById("themsp").innerHTML = "C·∫≠p nh·∫≠t s·∫£n ph·∫©m"

    document.getElementById("btn_footermodal").innerHTML = `
        <button 
                class="text-white inline-flex items-center gap-x-2 bg-blue-700 hover:bg-blue-800
                        focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg
                        text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700
                        dark:focus:ring-blue-800" onclick="dandleupdateProduct(${id})" id="updateproduct">
            <i class="fa-solid fa-pencil"></i>
            <span>C·∫≠p nh·∫≠t s·∫£n ph·∫©m</span>
        </button>
`

    // X√≥a to√†n b·ªô th√¥ng b√°o l·ªói (n·∫øu c√≥)
    const errorMessages = document.querySelectorAll(".sp-thongbao");
    errorMessages.forEach(el => el.innerText = "");  // ho·∫∑c el.textContent = ""


    getproductid(id)

}
window.dandleeditProduct = dandleeditProduct


//c·∫≠p nh·∫≠t l·∫°i d·ªØ li·ªáu

const dandleupdateProduct = (id) => {

    const name = document.getElementById("name").value;
    const price = document.getElementById("price").value;
    const screen = document.getElementById("screen").value;
    const backCamera = document.getElementById("backCamera").value;
    const frontCamera = document.getElementById("frontCamera").value;
    const img = document.getElementById("img").value;
    const type = document.getElementById("category").value;
    const desc = document.getElementById("desc").value;

    const isValid = validation(name, price, img, screen, backCamera, frontCamera, desc, "category");
    if (!isValid) return;

    const sp = new Product(id, name, price, screen, backCamera, frontCamera, img, type, desc)

    updateproductid(sp);

    document.getElementById("close_modal").click();

}


window.dandleupdateProduct = dandleupdateProduct;

//delete product

const dandledeletetProduct = (id) => {
    const promise = axios({
        url: `https://68f5f9ef6b852b1d6f15ab33.mockapi.io/product/${id}`,
        method: 'DELETE',
    })
    promise
        .then(() => {
            getlistproduct()
        })
        .catch((result) => {
            console.log(result)

        })
}
window.dandledeletetProduct = dandledeletetProduct;


//add product

document.getElementById("addproduct").onclick = () => {

    document.getElementById("themsp").innerHTML = "Th√™m s·∫£n ph·∫©m"

    document.getElementById("btn_footermodal").innerHTML = `
        <button 
                class="text-white inline-flex items-center bg-blue-700 hover:bg-blue-800
                        focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg
                        text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700
                        dark:focus:ring-blue-800" onclick="dandleaddProduct()">
            <svg class="me-1 -ms-1 w-5 h-5" fill="currentColor" viewBox="0 0 20 20"
                      xmlns="http://www.w3.org/2000/svg">
                      <path fill-rule="evenodd"
                        d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"
                        clip-rule="evenodd"></path>
            </svg>
            <span>Th√™m s·∫£n ph·∫©m m·ªõi</span>
        </button>
`
    document.getElementById("formmodal").reset()

    // X√≥a to√†n b·ªô th√¥ng b√°o l·ªói (n·∫øu c√≥)
    const errorMessages = document.querySelectorAll(".sp-thongbao");
    errorMessages.forEach(el => el.innerText = "");  // ho·∫∑c el.textContent = ""
}

const dandleaddProduct = () => {
    const name = document.getElementById("name").value;
    const price = document.getElementById("price").value;
    const screen = document.getElementById("screen").value;
    const backCamera = document.getElementById("backCamera").value;
    const frontCamera = document.getElementById("frontCamera").value;
    const img = document.getElementById("img").value;
    const type = document.getElementById("category").value;
    const desc = document.getElementById("desc").value;


    // // G·ªçi v√† ki·ªÉm tra k·∫øt qu·∫£ validation ƒë√∫ng c√°ch
    const isValid = validation(name, price, img, screen, backCamera, frontCamera, desc, "category");
    if (!isValid) return;

    const sp = new Product("", name, price, screen, backCamera, frontCamera, img, type, desc)



    // if (!name || !price || !img || !type) {
    //     alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc!");
    //     return;
    // }


    const promise = axios({
        url: `https://68f5f9ef6b852b1d6f15ab33.mockapi.io/product`,
        method: 'POST',
        data: sp,
    })
    promise
        .then(() => {
            getlistproduct()

        })
        .catch((result) => {
            console.log(result)

        })
    document.getElementById("close_modal").click();
}
window.dandleaddProduct = dandleaddProduct;


//search by name

//h√†m b·ªè d·∫•u ti·∫øng vi·ªát
const removeVietnameseTones = (str) => {
    return str
        .normalize("NFD") // t√°ch d·∫•u ra kh·ªèi k√Ω t·ª± g·ªëc
        .replace(/[\u0300-\u036f]/g, "") // x√≥a d·∫•u
        .replace(/ƒë/g, "d")
        .replace(/ƒê/g, "D")
        .toLowerCase(); // chuy·ªÉn v·ªÅ ch·ªØ th∆∞·ªùng
}

const search = (arr) => {
    document.getElementById("search-box").addEventListener("keyup", () => {
        const keyword = document.getElementById("search-box").value;

        let searchloai = [];

        const keywordNormalized = removeVietnameseTones(keyword);

        for (let i = 0; i < arr.length; i++) {
            const phone = arr[i];


            const loaiNormalized = removeVietnameseTones(phone.name);

            if (loaiNormalized.indexOf(keywordNormalized) !== -1) {
                searchloai.push(phone);
            }
        }

        renderproduct(searchloai)
    })
}


// Toggle sidebar on mobile
const toggle = document.querySelector(".menu-toggle");
const sidebar = document.querySelector(".sidebar");

// Khi click v√†o n√∫t ‚ò∞ th√¨ b·∫≠t/t·∫Øt menu
toggle.addEventListener("click", (e) => {
    e.stopPropagation(); // NgƒÉn ch·∫∑n click lan ra ngo√†i
    sidebar.classList.toggle("active");
});

// Khi click ra ngo√†i menu th√¨ ·∫©n menu
document.addEventListener("click", (e) => {
    if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
        sidebar.classList.remove("active");
    }
});

document.addEventListener("submit", function (e) {
    e.preventDefault();
    console.log("Form submit b·ªã ch·∫∑n ƒë·ªÉ kh√¥ng reload trang");
});



//S·∫Øp x·∫øp s·∫£n ph·∫©m theo gi√° ti·ªÅn (t·ª´ l·ªõn ƒë·∫øn b√©, v√† ng∆∞·ª£c l·∫°i)

const sortSelect = (manggoc) => {
    const sort = document.getElementById("sortSelect").value

    const data = [...manggoc];

    if (sort === "ascending") {
        //s·∫Øp x·∫øp tƒÉng
        for (let i = 0; i < data.length - 1; i++) {
            for (let j = i + 1; j < data.length; j++) {

                if (data[i].price > data[j].price) {
                    let temp = data[i];
                    data[i] = data[j]
                    data[j] = temp
                }
            }

        }

    } else if (sort === "descending") {
        //s·∫Øp x·∫øp gi·∫£m
        for (let i = 0; i < data.length - 1; i++) {
            for (let j = i + 1; j < data.length; j++) {

                if (data[i].price < data[j].price) {
                    let temp = data[i];
                    data[i] = data[j]
                    data[j] = temp
                }
            }

        }
    } else if (sort === "none") {
        renderproduct(manggoc)
        return

    }






    renderproduct(data)

}
